<div class="row pad-bottom">
    <div id="atlas-locator-map" class="twelve columns"></div>
    <div class="twelve columns relative">

      <div class="atlas-map-overlay top-left stacked">
        <h5 class="overlay-item"><%= @atlas.title %></h5>
        <p class="overlay-item"><%= pluralize(@atlas.pages.length, 'page') %></p>
      </div>

      <% if Providers.derive(@atlas.provider) === 'openstreetmap'  %>
      <div class="atlas-map-overlay top-right">
        <form action="#" accept-charset="utf-8" method="POST">
          <button type="submit"><%= _("Refresh") %></button>
          <input type="hidden" name="title" value="<%=h @atlas.title %>">
          <input type="hidden" name="text" value="<%=h @atlas.text %>">
          <input type="hidden" name="zoom" value="<%= @atlas.zoom %>">
          <input type="hidden" name="paper_size" value="<%=h @atlas.paper_size %>">
          <input type="hidden" name="orientation" value="<%=h @atlas.orientation %>">
          <input type="hidden" name="provider" value="<%=h @atlas.provider %>">
          <input type="hidden" name="refreshed_from" value="<%= @atlas.id %>">
          <% @atlas.pages.each do |page| %>
            <% if page.page_number != 'i' %>
            <input type="hidden" name="pages[<%=h page.page_number %>]" value="<%=h page.bbox.join(',') %>">
            <% end %>
          <%end %>
        </form>
      </div>
      <% end %>

      <div class="atlas-map-overlay bottom-right">
        <form action="#" accept-charset="utf-8" method="POST">
          <button type="submit"><%= _("Copy this atlas") %></button>
          <input type="hidden" name="title" value="<%=h @atlas.title %>">
          <input type="hidden" name="text" value="<%=h @atlas.text %>">
          <input type="hidden" name="zoom" value="<%= @atlas.zoom %>">
          <input type="hidden" name="paper_size" value="<%=h @atlas.paper_size %>">
          <input type="hidden" name="orientation" value="<%=h @atlas.orientation %>">
          <input type="hidden" name="provider" value="<%=h @atlas.provider %>">
          <input type="hidden" name="cloned_from" value="<%= @atlas.id %>">
          <% @atlas.pages.each do |page| %>
            <% if page.page_number != 'i' %>
            <input type="hidden" name="pages[<%=h page.page_number %>]" value="<%=h page.bbox.join(',') %>">
            <% end %>
          <%end %>
        </form>

        <a href="<%= @atlas.pdf_url %>" class="button"><%= _("Download PDF") %></a>
      </div>

      <div id="atlas-map"></div>
    </div>
</div>

<div class="row">
    <div class="eight columns atlases-activity">
      <h4><%= _("Activity") %></h4>
      <ul class="pad-bottom">
        <li>
          <p><%= @atlas.creator_name %> made this atlas <%= link_to _("%{time_period} ago") % { time_period: time_ago_in_words(@atlas.created_at) }, atlases_path(month: @atlas.created_at.strftime("%Y-%m")) %></p>
          <p class="details"><%= pluralize(@atlas.pages.length, 'page') %> + <%= Providers.derive(@atlas.provider) %> + <%= @atlas.orientation %> + <%= @atlas.layout %></p>
        </li>
        <% if @atlas.refreshed_from  %>
          <li>This atlas is a <i>refresh</i> of <%= link_to(@atlas.refreshed_from, atlas_path(@atlas.refreshed_from)) %> </li>
        <% end %>
        <% if @atlas.cloned_from  %>
          <li>This atlas is a <i>copy</i> of <%= link_to(@atlas.cloned_from, atlas_path(@atlas.refreshed_from)) %> </li>
        <% end %>
        <% if !@atlas.snapshots.empty? %>
          <%= render partial: "atlas_snapshot", collection: @atlas.snapshots %>
        <% end %>
      </ul>


    </div>

    <div class="four columns">
      <div class="u-pull-right no-wrap options-list">
        <h6 class="options-list-title"><%= _("Export Data") %></h6>
        <ul>
          <li><a href="#"><%= _("GeoJSON") %></a></li> <!-- http://fieldpapers.org/activity.php?print=ndx9fx4v&type=json -->
          <li><a href="<%= atlas_path(format: :csv) %>"><%= _("Plain Text (CSV)") %></a></li> <!-- http://fieldpapers.org/activity.php?print=ndx9fx4v&type=csv -->
          <li><a href="#"><%= _("ShapeFile") %></a></li> <!-- http://fieldpapers.org/activity.php?print=ndx9fx4v&type=shp -->
        </ul>

        <h6 class="options-list-title"><%= _("Edit in...") %></h6>
        <ul>
          <li><a href=<%= iDLink @atlas %> target="_blank"><%= _("iD") %></a></li>
          <li><a href=<%= potlatchLink @atlas %> target="_blank"><%= _("Potlatch") %></a></li>
        </ul>
      </div>
    </div>
</div>

<% content_for :foot do %>
  <script>
    $(function(){
      var providers = <%= Providers.layers.to_json.html_safe %>;
      var defaultProvider = "<%= Providers.default %>";
      var atlasProvider = "<%= @atlas.pages[0].provider %>";
      var bbox = <%= @atlas.bbox %>;
      var pages = <%= @atlas.pages.to_json.html_safe %>;


      FP.map.locator('atlas-locator-map', {
        bbox: bbox,
        providers: providers,
        provider: atlasProvider,
        defaultProvider: defaultProvider,
        showMarker: true,
        zoom: 5
      });

      FP.map.atlas('atlas-map',{
        bbox: bbox,
        providers: providers,
        provider: atlasProvider,
        defaultProvider: defaultProvider,
        pages: pages
      });
    });
  </script>
<% end %>
